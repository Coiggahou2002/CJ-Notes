# 记一次奇怪的部署

这两天一直在赶用户权限的前端部分逻辑，到了今天上午基本上做完了。

于是呢就想，我把项目 build 一下然后部署上线，看看效果如何。

很快啊，啪的一下，我 `npm run build` 之后把静态资源扔到我阿里云学生机上，配好了 Nginx，美滋滋。

地址栏输入公网 IP，好家伙，给爷来个 404。

噢，其实这只是 Vue Router 的 history 模式的一个小坑，配一下就好了。

下午闲着没事把 404 页面也整了点活，感觉还挺好。

![](https://cjpark-1304138896.cos.ap-guangzhou.myqcloud.com/note_img/20211026212457.png)

这时候我还不知道，玄学问题又悄悄地来了。

上线之后通过公网 IP 访问网站，发现有几个页面有些异常，打开 Network 看请求收发，发现有一些静态资源没加载出来，又去控制台看报错，一堆爆红，全都是 CORS 相关的问题，也就是说，我通过外链请求加载的静态资源，几乎全被跨域策略拦住了。

![](https://cjpark-1304138896.cos.ap-guangzhou.myqcloud.com/note_img/20211026212515.png)

我没有仔细研究过跨域资源共享规则，但凭我脑子里对 CORS 这个东西的印象来讲，因为跨域问题被拦截，一般都是接收请求的服务端的锅，跟我前端有什么关系？

那我就琢磨了，我大部分的外链都是 [cdn.js.cloudflare.com](cdn.js.cloudflare.com) 这家伙的，会不会是这个服务商的服务端的配置有点啥大病？

后来我寻思，应该不是，因为我还有两个静态资源也被跨域拦住了，一个是 Vuetify 的官方 logo 图片，一个是我从我自己的 gitee 博客上链过来的图片，这俩就真的是普普通通的平民老百姓外链，怎么也能被拦呢？

那可以排除这些外链本身的问题了。

还有一个现象比较奇怪——在这次部署之前，我的这个前端项目一直是在本地跑的，一直在 `localhost` 的 8080 端口，为什么我在本地跑的时候从来没有遇到过请求资源被拦的问题呢？

我上网查了很久，最终在 StackOverflow 上找到一个高度匹配的问题，下面只有一条答案，它说这是最新版 Chrome 浏览器新增的安全策略，就是防止相对更 public 的源去跨域请求相对更 private 的源的资源，解决方法是手动在 Chrome 的安全策略里禁用掉某一条设置。

![](https://cjpark-1304138896.cos.ap-guangzhou.myqcloud.com/note_img/20211026212529.png)

![](https://cjpark-1304138896.cos.ap-guangzhou.myqcloud.com/note_img/20211026212544.png)

我试了一下，欸，还真行，禁用之后，这个问题消失了。

![](https://cjpark-1304138896.cos.ap-guangzhou.myqcloud.com/note_img/20211026212553.png)

但我又想，这可不能这么解决啊，万一别的访问我网站的人的电脑装的也是新版 Chrome 呢？也有这个安全策略呢？

然后我又突发奇想，用 Firefox 试试？毕竟这个策略是 Chrome 新增的，而 Firefox 和 Chrome 用的是不同的内核。然后我发现，Firefox 确实不会出现上述问题

那难道这就是浏览器层面的问题了吗，这个问题难道无解了吗？

俺思来想去，觉得不可能啊，Vue CLI 打包前端应用部署上线，然后在加载组件的过程中请求外部静态资源，这是一个非常普遍而且常见的需求啊。

既然是很普遍的需求，那其他人也应该会在部署过程中遇到这样的问题，从而网上应该会有大量有关该问题的讨论和解决方案，但事实上并没有！相关的问题和讨论几乎为零！

这说明很可能还是我的电脑有那个大病。

然后神奇的一幕出现了，我去上了个厕所，想着这个月梯子流量可能快没了，回来之后就把常年开着的梯子给关了。

欸我的妈！那个问题直接就解决了！远程请求静态资源再也没有被 CORS 拦过！

我都要哭出来了！！

我的妈，我研究了一下午，你就这么给我解决了？？

我后来又通过一些控制变量的测试手段，证实了确实是我的梯子导致的问题。

虽然最终也没怎么弄明白，但咱还是尝试来梳理一下：

1. 本地跑项目没问题，上线之后请求外链静态资源被 CORS 拦截
2. 用 Firefox 或者旧版 Chrome 都没问题，用新版 Chrome 或 Edge 都有此问题出现
3. 据说这是 Chrome 新增的安全策略，不允许更 public 的源去跨域请求更 private 的源上的资源

也就是说说，我在本地跑项目的时候，我的机子走代理（可能走了，也可能没走，因为我选择了跳过中国站点）之后去请求远程静态资源，是没有问题的。

但是，当我通过公网 IP 去访问我部署项目的阿里云学生机的 80 端口来访问我的网站时（这个肯定是走了我梯子的代理的），在我走了代理的情况下，我的 Nginx 在为我请求静态资源的时候遇到了 CORS 拦截，而我没走代理的时候，Nginx 是能够正常为我请求静态资源的。

那么问题应该就出在：我的代理服务器和我的 Nginx 沟通的时候出现了问题，触发了 Chrome 新增的安全策略中的“不允许 public 的源请求 private 的源”的情况。

剩下的俺就分析不清楚了。

![](https://cjpark-1304138896.cos.ap-guangzhou.myqcloud.com/note_img/20211026212609.png)

唉，书到用时方恨少，头发掉时不知道啊！

希望学完计算机网络之后能够回来解答这个问题。

